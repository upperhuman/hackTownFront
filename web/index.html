<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>LocalLens</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.png">

  <script>
    // –≠—Ç–æ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä Flutter –∑–∞–º–µ–Ω–∏—Ç –Ω–∞ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ 12345678 (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç {{‚Ä¶}})
    const rawServiceWorkerVersion = "{{flutter_service_worker_version}}";
    // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, –∫–æ–Ω–≤–µ—Ä—Ç–∏–º –≤ Number, –∏–Ω–∞—á–µ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–æ–π
    const serviceWorkerVersion =
      !isNaN(Number(rawServiceWorkerVersion))
        ? Number(rawServiceWorkerVersion)
        : rawServiceWorkerVersion;

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å ReferenceError
    // Build-–ø—Ä–æ—Ü–µ—Å—Å (envsubst/sed) –º–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å {{GOOGLE_MAP_API}} –Ω–∞ –≤–∞—à –∫–ª—é—á
    window.INJECTED_GOOGLE_MAP_API = "{{GOOGLE_MAP_API}}";
  </script>

  <!-- –ø–æ–¥–∫–ª—é—á–∞–µ–º flutter.js -->
  <script src="flutter.js" defer></script>
</head>
<body>
<script>
  window.addEventListener('load', async () => {
    try {
      // 1) –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∫–ª—é—á –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
      let apiKey =
        typeof window.INJECTED_GOOGLE_MAP_API === 'string' &&
        !window.INJECTED_GOOGLE_MAP_API.includes('{{')
          ? window.INJECTED_GOOGLE_MAP_API
          : null;

      // 2) –ï—Å–ª–∏ —Ç–∞–º –≤—Å—ë –µ—â—ë –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º .env –∏–∑ –∞—Å—Å–µ—Ç–æ–≤
      if (!apiKey) {
        const resp = await fetch('assets/.env');
        const text = await resp.text();
        // –û–∂–∏–¥–∞–µ–º –≤ .env —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ GOOGLE_MAP_API=–í–∞—à–ö–ª—é—á
        const match = text.match(/^GOOGLE_MAP_API\s*=\s*(.+)$/m);
        apiKey = match ? match[1].trim() : null;
      }

      if (!apiKey) {
        console.error('üõë Google Maps API key not found');
        return;
      }

      // 3) –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç Google Maps
      const mapScript = document.createElement('script');
      mapScript.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}`;
      mapScript.async = true;
      document.head.appendChild(mapScript);

      // 4) –ó–∞–ø—É—Å–∫–∞–µ–º Flutter‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      _flutter.loader.loadEntrypoint({
        serviceWorker: { serviceWorkerVersion },
        onEntrypointLoaded: engineInitializer => {
          engineInitializer.initializeEngine()
            .then(appRunner => appRunner.runApp());
        }
      });
    } catch (err) {
      console.error('Error initializing app:', err);
    }
  });
</script>
</body>
</html>
