<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>LocalLens</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.png">
  <!-- Flutter —Å–∞–º –∑–∞–º—ñ–Ω—é—î —Ü–µ–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–∞ —á–∏—Å–ª–æ –≤–µ—Ä—Å—ñ—ó –≤–∞—à–æ–≥–æ service worker -->
  <script>
    const serviceWorkerVersion = "{{flutter_service_worker_version}}";
    // –ü—ñ–¥ —á–∞—Å –∑–±—ñ—Ä–∫–∏ CI/CD –≤–∏ –º–æ–∂–µ—Ç–µ —ñ–Ω–∂–µ–∫—Ç–∏—Ç–∏ —Å—é–¥–∏ —Å–≤—ñ–π –∫–ª—é—á —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω—ñ–∑–∞—Ç–æ—Ä:
    // –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, envsubst –∞–±–æ sed –∑–∞–º—ñ–Ω–∏—Ç—å '{{GOOGLE_MAP_API}}' –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏–π –∫–ª—é—á.
    const INJECTED_GOOGLE_MAP_API = "{{GOOGLE_MAP_API}}";
  </script>
  <script src="flutter.js" defer></script>
</head>
<body>
<script>
  window.addEventListener('load', async () => {
    try {
      // 1) –°–ø—Ä–æ–±—É—î–º–æ –≤–∑—è—Ç–∏ –∫–ª—é—á –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó JS‚Äë–∑–º—ñ–Ω–Ω–æ—ó
      let apiKey = INJECTED_GOOGLE_MAP_API && !INJECTED_GOOGLE_MAP_API.includes('{{')
        ? INJECTED_GOOGLE_MAP_API
        : null;

      // 2) –Ø–∫—â–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–µ –±—É–≤ –∑–∞–º—ñ–Ω–µ–Ω–∏–π ‚Äî –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–º–æ .env –∑ assets
      if (!apiKey) {
        const resp = await fetch('assets/.env');
        const text = await resp.text();
        const m = text.match(/GOOGLE_MAP_API\s*=\s*['"]?(.+?)['"]?/);
        apiKey = m?.[1] ?? null;
      }

      if (!apiKey) {
        console.error('üõë Google Maps API key not found');
        return;
      }

      // 3) –î–∏–Ω–∞–º—ñ—á–Ω–æ –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–∫—Ä–∏–ø—Ç Google Maps
      const mapScript = document.createElement('script');
      mapScript.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}`;
      mapScript.async = true;
      document.head.appendChild(mapScript);

      // 4) –ù–∞—Ä–µ—à—Ç—ñ, –∑–∞–ø—É—Å–∫–∞—î–º–æ Flutter
      _flutter.loader.loadEntrypoint({
        serviceWorker: { serviceWorkerVersion },
        onEntrypointLoaded: engineInitializer => {
          engineInitializer.initializeEngine()
            .then(appRunner => appRunner.runApp());
        }
      });
    } catch (err) {
      console.error('Error initializing app:', err);
    }
  });
</script>
</body>
</html>
